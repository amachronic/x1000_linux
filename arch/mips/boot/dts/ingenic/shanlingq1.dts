// SPDX-License-Identifier: GPL-2.0
/dts-v1/;

#include "x1000.dtsi"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/clock/ingenic,sysost.h>
#include <dt-bindings/interrupt-controller/irq.h>

/ {
	compatible = "shanling,q1", "ingenic,x1000e";
	model = "Shanling Q1";

	memory {
		device_type = "memory";
		reg = <0x0 0x4000000>;
	};

	es9218p_xi_clk: clock-es9218p-xi {
		compatible = "fixed-clock";
		#clock-cells = <0>;
		clock-frequency = <38400000>;
	};

	es9218p_en_reg: regulator-es9218p-en {
		compatible = "regulator-fixed";

		regulator-name = "es9218p_en_reg";
		/* dummy voltages */
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <1800000>;

		gpio = <&gpb 13 GPIO_ACTIVE_HIGH>;
		enable-active-high;
	};

	ft6x06_en_reg: regulator-ft6x06-en {
		compatible = "regulator-fixed";

		regulator-name = "ft6x06_en_reg";
		/* dummy voltages */
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <1800000>;

		gpio = <&gpb 8 GPIO_ACTIVE_HIGH>;
		enable-active-high;
	};

	battery: battery {
		compatible = "simple-battery";

		device-chemistry = "lithium-ion";
		charge-full-design-microamp-hours = <1100000>;

		voltage-min-design-microvolt = <3300000>;
		voltage-max-design-microvolt = <4200000>;
		over-voltage-threshold-microvolt = <4400000>;

		constant-charge-current-max-microamp = <630000>;
		constant-charge-voltage-max-microvolt = <4200000>;
	};

	backlight {
		compatible = "pwm-backlight";
		pwms = <&pwm 0 10000 0>;

		pinctrl-names = "default";
		pinctrl-0 = <&pins_pwm0>;
	};

	gpio-keys {
		compatible = "gpio-keys";

		button-0 {
			label = "power";
			linux,code = <KEY_POWER>;
			gpios = <&gpb 31 GPIO_ACTIVE_LOW>;
		};

		button-1 {
			label = "play";
			linux,code = <KEY_PLAY>;
			gpios = <&gpb 28 GPIO_ACTIVE_LOW>;
		};

		button-2 {
			label = "previous";
			linux,code = <KEY_PREVIOUS>;
			gpios = <&gpb 21 GPIO_ACTIVE_LOW>;
		};

		button-3 {
			label = "next";
			linux,code = <KEY_NEXT>;
			gpios = <&gpb 22 GPIO_ACTIVE_LOW>;
		};
	};

	rotary-encoder {
		compatible = "rotary-encoder";
		gpios = <&gpd 2 GPIO_ACTIVE_HIGH>,
			<&gpd 3 GPIO_ACTIVE_HIGH>;
		linux,axis = <REL_WHEEL>;
		rotary-encoder,relative-axis;
	};
};

&exclk {
	clock-frequency = <24000000>;
};

&cgu {
	/*
	 * Use the 32.768 kHz oscillator as the parent of the RTC for a higher
	 * precision. Use EXCLK as the parent of the I2S system clock just so
	 * it has a well defined parent.
	 */
	assigned-clocks = <&cgu X1000_CLK_RTC>,
			  <&cgu X1000_CLK_I2S>;
	assigned-clock-parents = <&cgu X1000_CLK_RTCLK>,
				 <&cgu X1000_CLK_EXCLK>;
};

&ost {
	/* 1500 kHz for the system timer and clocksource */
	assigned-clocks = <&ost OST_CLK_PERCPU_TIMER>,
			  <&ost OST_CLK_GLOBAL_TIMER>;
	assigned-clock-rates = <1500000>,
			       <1500000>;
};

&tcu {
	/*
	 * Set channel mask to allow PWM0 to be used.
	 */
	ingenic,pwm-channels-mask = <0x01>;

	/*
	 * Use PCLK as the parent for the PWM backlight timer to
	 * maximize the number of brightness steps.
	 *
	 * Also have to set timer2 to avoid a driver probe error
	 * Set WDT since it seems needed
	 * Set timer1 just in case it is getting used but idk
	 * TODO recheck this stuff
	 */
	assigned-clocks = <&tcu TCU_CLK_TIMER0>,
			  <&tcu TCU_CLK_TIMER1>,
			  <&tcu TCU_CLK_TIMER2>,
			  <&tcu TCU_CLK_WDT>;
	assigned-clock-parents = <&cgu X1000_CLK_PCLK>,
				 <&cgu X1000_CLK_PCLK>,
				 <&cgu X1000_CLK_PCLK>,
				 <&cgu X1000_CLK_RTCLK>;
	assigned-clock-rates = <0>,
			       <1500000>,
			       <1500000>,
			       <24000000>;
};

&rtc {
	ingenic,rtc-valid-value = <0x52544356>;
};

&rng {
	status = "okay";
};

&i2c0 {
	status = "okay";

	clock-frequency = <400000>;

	pinctrl-names = "default";
	pinctrl-0 = <&pins_i2c0>;

	ft6x06: touchscreen@38 {
		/* Max 5 touchpoints reported */
		compatible = "edt,edt-ft5206";
		reg = <0x38>;

		interrupt-parent = <&gpa>;
		interrupts = <16 IRQ_TYPE_EDGE_FALLING>;

		reset-gpios = <&gpa 19 GPIO_ACTIVE_LOW>;

		vcc-supply = <&ft6x06_en_reg>;
		iovcc-supply = <&ft6x06_en_reg>;

		touchscreen-size-x = <360>;
		touchscreen-size-y = <400>;
	};
};

&i2c1 {
	status = "okay";

	clock-frequency = <100000>;

	pinctrl-names = "default";
	pinctrl-0 = <&pins_i2c1>;
};

&i2c2 {
	status = "okay";

	clock-frequency = <400000>;

	pinctrl-names = "default";
	pinctrl-0 = <&pins_i2c2>;

	axp192: pmic@34 {
		reg = <0x34>;

		interrupt-parent = <&gpc>;
		interrupts = <21 IRQ_TYPE_LEVEL_LOW>;

		pinctrl-names = "default";
		pinctrl-0 = <&pins_axp192>;
	};

	cw2015: fuel-gauge@62 {
		compatible = "cellwise,cw2015";
		reg = <0x62>;

		monitored-battery = <&battery>;
		power-supplies = <&usb_power_supply>;

		cellwise,monitor-interval-ms = <500>;
		cellwise,battery-profile = /bits/ 8 <
			0x15 0x7E 0x61 0x59 0x57 0x55 0x56 0x4C
			0x4E 0x4D 0x50 0x4C 0x45 0x3A 0x2D 0x27
			0x22 0x1E 0x19 0x1E 0x2A 0x3C 0x48 0x45
			0x1D 0x94 0x08 0xF6 0x15 0x29 0x48 0x51
			0x5D 0x60 0x63 0x66 0x45 0x1D 0x83 0x38
			0x09 0x43 0x16 0x42 0x76 0x98 0xA5 0x1B
			0x41 0x76 0x99 0xBF 0x80 0xC0 0xEF 0xCB
			0x2F 0x00 0x64 0xA5 0xB5 0x0E 0x30 0x29
		>;
	};
};

&msc0 {
	status = "okay";

	bus-width = <4>;
	max-frequency = <50000000>;

	pinctrl-names = "default";
	pinctrl-0 = <&pins_msc0>;

	cd-gpios = <&gpb 9 GPIO_ACTIVE_LOW>;
};

&msc1 {
	status = "okay";

	bus-width = <4>;
	max-frequency = <50000000>;
	non-removable;

	pinctrl-names = "default";
	pinctrl-0 = <&pins_msc1>;
};

&otg {
	status = "okay";
	dr_mode = "peripheral";
};

&otg_phy {
	status = "okay";
};

&pinctrl {
	pins_axp192: axp192 {
		/* pullup required on interrupt line */
		pins = "PC21";
		bias-pull-up;
	};

	pins_i2c0: i2c0 {
		function = "i2c0";
		groups = "i2c0-data";
		bias-pull-up;
	};

	pins_i2c1: i2c1 {
		function = "i2c1";
		groups = "i2c1-data-c";
		bias-pull-up;
	};

	pins_i2c2: i2c2 {
		function = "i2c2";
		groups = "i2c2-data";
		bias-pull-up;
	};

	pins_msc0: msc0 {
		function = "mmc0";
		groups = "mmc0-1bit", "mmc0-4bit";
		bias-disable;
	};

	pins_msc1: msc1 {
		function = "mmc1";
		groups = "mmc1-1bit", "mmc1-4bit";
		bias-disable;
	};

	pins_pwm0: pwm0 {
		function = "pwm0";
		groups = "pwm0";
	};
};

#include <arm/axp192.dtsi>

&battery_power_supply {
	monitored-battery = <&battery>;
};

/*
 * For now, turn on all regulators.
 */

&reg_dcdc1 {
	regulator-always-on;
};

&reg_dcdc2 {
	regulator-always-on;
};

&reg_dcdc3 {
	regulator-always-on;
};

&reg_ldo2 {
	regulator-always-on;
};

&reg_ldo3 {
	regulator-always-on;
};
